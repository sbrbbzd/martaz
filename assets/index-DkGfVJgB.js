import{u as ge,$ as fe,a as xe,k as G,s as ue,a0 as je,r as p,a1 as ve,b as Ne,w as _e,a2 as be,j as e,H as we,a3 as ye,f as Fe,L as v,V,a4 as K,a5 as Le,a6 as Ie,a7 as Ce,a8 as Pe,a9 as ze,aa as Q}from"./index-CEw6XCQe.js";import{V as d}from"./index-CaFybOz9.js";const Ee=()=>{var X,R,B,H;const{t:a}=ge(),N=fe(),_=xe(),t=G(ue),z=G(je),[n,b]=p.useState("profile"),[l,D]=p.useState({firstName:(t==null?void 0:t.firstName)||"",lastName:(t==null?void 0:t.lastName)||"",email:(t==null?void 0:t.email)||"",phone:(t==null?void 0:t.phone)||"",profileImage:(t==null?void 0:t.profileImage)||""}),[w,$]=p.useState({page:1,limit:10,status:"all"}),W=[{value:"all",label:a("profile.filters.all")},{value:"active",label:a("profile.filters.active")},{value:"pending",label:a("profile.filters.pending")},{value:"sold",label:a("profile.filters.sold")}],[S,J]=p.useState({page:1,limit:10}),{data:o,isLoading:Y,refetch:Z}=ve(w,{skip:n!=="listings"||!t}),{data:c,isLoading:ee}=Ne({...S,favorites:!0},{skip:n!=="favorites"||!t}),[se,{isLoading:ae}]=_e(),[ie,{isLoading:De}]=be(),[k,te]=p.useState(null),[E,T]=p.useState(null),[A,M]=p.useState(null);p.useEffect(()=>{if(!t){_("/login");return}D({firstName:t.firstName||"",lastName:t.lastName||"",email:t.email||"",phone:t.phone||"",profileImage:t.profileImage||""})},[t,_]);const y=s=>{const{name:i,value:h}=s.target;D({...l,[i]:h})},le=async s=>{s.preventDefault(),M(null);try{if(await N(ze({firstName:l.firstName,lastName:l.lastName,phone:l.phone})).unwrap(),k){const i=new FormData;i.append("profileImage",k),await N(Q(i)).unwrap(),te(null),T(null)}d.success(a("profile.profileUpdated"))}catch(i){console.error("Failed to update profile:",i),M(i.message||"Failed to update profile. Please try again."),d.error(i.message||a("common.errorOccurred"))}},re=s=>new Promise((i,h)=>{const r=new FileReader;r.readAsDataURL(s),r.onload=()=>i(r.result),r.onerror=m=>h(m)}),ne=async(s,i=.5)=>new Promise((h,r)=>{const m=new Image,u=document.createElement("canvas"),g=u.getContext("2d");if(!g){r(new Error("Could not get canvas context"));return}const F=new FileReader;F.onload=L=>{if(!L.target||!L.target.result){r(new Error("File read failed"));return}m.onload=()=>{let f=m.width,x=m.height;const I=800,C=800;f>I&&(x=Math.round(x*(I/f)),f=I),x>C&&(f=Math.round(f*(C/x)),x=C),u.width=f,u.height=x,g.drawImage(m,0,0,f,x);let P=.8;const he=j=>new Promise(O=>{u.toBlob(q=>{O(q||new Blob([new Uint8Array(0)],{type:s.type}))},"image/jpeg",j)});(async()=>{try{for(;;){const j=await he(P);if(j.size>i*1024*1024&&P>.2){P-=.1;continue}else{h(j);break}}}catch(j){r(j)}})()},m.src=L.target.result},F.onerror=()=>{r(new Error("Error reading file"))},F.readAsDataURL(s)}),oe=async s=>{if(s.target.files&&s.target.files.length>0){const i=s.target.files[0];if(i.size>5*1024*1024){d.error(a("profile.imageTooLarge"));return}if(!i.type.startsWith("image/")){d.error(a("profile.invalidImageType"));return}const h=URL.createObjectURL(i);T(h);try{const r=await ne(i,.5);console.log(`Original size: ${i.size/1024}KB, Compressed size: ${r.size/1024}KB`);const u=(await re(new File([r],i.name,{type:"image/jpeg"}))).split(",")[1],g=new FormData;g.append("imageData",u),g.append("mimeType","image/jpeg"),g.append("fileName",i.name),N(Q(g))}catch(r){console.error("Error uploading profile image:",r),d.error(a("profile.imageUploadError"))}}},ce=async s=>{if(window.confirm(a("profile.confirmDeleteListing")))try{await se(s).unwrap(),d.success(a("profile.listingDeleted")),Z()}catch(i){console.error("Failed to delete listing:",i),d.error(i.message||a("common.errorOccurred"))}},de=async s=>{try{await ie(s).unwrap(),d.success(a("profile.favoriteRemoved"))}catch(i){console.error("Failed to toggle favorite:",i),d.error(i.message||a("common.errorOccurred"))}},U=()=>{n==="listings"?$(s=>({...s,page:s.page+1})):n==="favorites"&&J(s=>({...s,page:s.page+1}))},me=(s,i)=>`${(s==null?void 0:s.charAt(0))||""}${(i==null?void 0:i.charAt(0))||""}`.toUpperCase(),pe=s=>{$(i=>({...i,page:1,status:s}))};return e.jsxs("div",{className:"container",children:[e.jsxs(we,{children:[e.jsxs("title",{children:[a("profile.pageTitle")," | Mart.az"]}),e.jsx("meta",{name:"description",content:a("profile.metaDescription")})]}),e.jsx("div",{className:"profile-page",children:e.jsxs("div",{className:"profile-container",children:[e.jsxs("div",{className:"profile-tabs",children:[e.jsx("div",{className:`profile-tabs__item ${n==="profile"?"profile-tabs__item--active":""}`,onClick:()=>b("profile"),children:a("profile.tabs.profile")}),e.jsx("div",{className:`profile-tabs__item ${n==="listings"?"profile-tabs__item--active":""}`,onClick:()=>b("listings"),children:a("profile.tabs.listings")}),e.jsx("div",{className:`profile-tabs__item ${n==="favorites"?"profile-tabs__item--active":""}`,onClick:()=>b("favorites"),children:a("profile.tabs.favorites")})]}),e.jsxs("div",{className:"profile-content",children:[n==="profile"&&e.jsxs("div",{className:"profile-info",children:[e.jsxs("div",{className:"profile-stats",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-card__value",children:((X=o==null?void 0:o.data)==null?void 0:X.total)||0}),e.jsx("div",{className:"stat-card__label",children:a("profile.stats.listings")})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-card__value",children:((R=c==null?void 0:c.data)==null?void 0:R.total)||0}),e.jsx("div",{className:"stat-card__label",children:a("profile.stats.favorites")})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-card__value",children:t!=null&&t.createdAt?new Date(t.createdAt).toLocaleDateString():"-"}),e.jsx("div",{className:"stat-card__label",children:a("profile.stats.memberSince")})]})]}),e.jsxs("div",{className:"profile-info__header",children:[e.jsx("h2",{children:a("profile.personalInfo")}),e.jsx("p",{children:a("profile.personalInfoSubtitle")})]}),e.jsxs("form",{onSubmit:le,className:"profile-info__form",children:[e.jsxs("div",{className:"profile-info__avatar",children:[e.jsx("div",{className:"profile-info__avatar-image",children:E||l.profileImage?e.jsx("img",{src:E||l.profileImage,alt:`${l.firstName} ${l.lastName}`}):e.jsx("span",{children:me(l.firstName,l.lastName)})}),e.jsxs("div",{className:"profile-info__avatar-upload",children:[e.jsx("input",{type:"file",id:"profileImage",name:"profileImage",accept:"image/*",onChange:oe}),e.jsxs("label",{htmlFor:"profileImage",children:[e.jsx(ye,{size:16}),a("profile.changePhoto")]})]})]}),e.jsxs("div",{className:"profile-info__details",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"firstName",children:a("profile.firstName")}),e.jsx("input",{type:"text",id:"firstName",name:"firstName",value:l.firstName,onChange:y,className:"form-control",required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"lastName",children:a("profile.lastName")}),e.jsx("input",{type:"text",id:"lastName",name:"lastName",value:l.lastName,onChange:y,className:"form-control",required:!0})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"email",children:a("profile.email")}),e.jsx("input",{type:"email",id:"email",name:"email",value:l.email,className:"form-control",disabled:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"phone",children:a("profile.phone")}),e.jsx("input",{type:"tel",id:"phone",name:"phone",value:l.phone,onChange:y,className:"form-control",placeholder:"+994 XX XXX XX XX"})]}),A&&e.jsxs("div",{className:"alert alert-danger",children:[e.jsx(Fe,{size:18}),e.jsx("span",{children:A})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"submit",className:"btn-primary",disabled:z,children:a(z?"common.saving":"profile.saveChanges")}),e.jsx("button",{type:"button",className:"btn-outline",onClick:()=>_("/"),children:a("common.cancel")})]})]})]})]}),n==="listings"&&e.jsxs("div",{className:"user-listings",children:[e.jsxs("div",{className:"user-listings__header",children:[e.jsx("h2",{children:a("profile.myListings")}),e.jsxs(v,{to:"/create-listing",className:"btn-add",children:[e.jsx(V,{size:16}),a("profile.createListing")]})]}),e.jsx("div",{className:"user-listings__filters",children:e.jsxs("div",{className:"filter-group",children:[e.jsxs("label",{children:[a("profile.filters.status"),":"]}),e.jsx("div",{className:"status-filter",children:W.map(s=>e.jsx("button",{className:`status-filter__btn ${w.status===s.value?"status-filter__btn--active":""}`,onClick:()=>pe(s.value),children:s.label},s.value))})]})}),Y?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:a("common.loading")})]}):(B=o==null?void 0:o.data)!=null&&B.listings&&o.data.listings.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"user-listings__grid",children:o.data.listings.map(s=>{var i;return e.jsxs("div",{className:"user-listings__item",children:[e.jsxs("div",{className:"user-listings__item-image",children:[e.jsx("img",{src:s.featuredImage||((i=s.images)==null?void 0:i[0])||`https://placehold.co/300x200?text=${encodeURIComponent(s.title)}`,alt:s.title}),e.jsx("div",{className:`status-badge status-badge--${s.status}`,children:a(`profile.listingStatus.${s.status}`)})]}),e.jsxs("div",{className:"user-listings__item-content",children:[e.jsx("h3",{className:"user-listings__item-title",children:s.title}),e.jsxs("div",{className:"user-listings__item-price",children:[s.price," ",s.currency]}),e.jsxs("div",{className:"user-listings__item-meta",children:[e.jsxs("div",{className:"location",children:[e.jsx(K,{size:12}),e.jsx("span",{children:s.location})]}),e.jsxs("div",{className:"views",children:[e.jsx(Le,{size:12}),e.jsx("span",{children:s.views})]})]}),e.jsxs("div",{className:"user-listings__item-actions",children:[e.jsxs(v,{to:`/edit-listing/${s.id}`,className:"btn-edit",children:[e.jsx(Ie,{size:14}),a("common.edit")]}),e.jsxs("button",{onClick:()=>ce(s.id),className:"btn-delete",disabled:ae,children:[e.jsx(Ce,{size:14}),a("common.delete")]})]})]})]},s.id)})}),o.data.totalPages>w.page&&e.jsx("div",{className:"load-more",children:e.jsx("button",{className:"btn-outline",onClick:U,children:a("common.loadMore")})})]}):e.jsxs("div",{className:"user-listings__empty",children:[e.jsx("h3",{children:a("profile.noListings")}),e.jsx("p",{children:a("profile.noListingsDescription")}),e.jsxs(v,{to:"/create-listing",className:"btn-add",children:[e.jsx(V,{size:18}),a("profile.createListing")]})]})]}),n==="favorites"&&e.jsxs("div",{className:"favorites",children:[e.jsx("div",{className:"favorites__header",children:e.jsx("h2",{children:a("profile.favorites")})}),ee?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:a("common.loading")})]}):(H=c==null?void 0:c.data)!=null&&H.listings&&c.data.listings.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"favorites__grid",children:c.data.listings.map(s=>{var i;return e.jsxs("div",{className:"favorites__item",children:[e.jsxs("div",{className:"favorites__item-image",children:[e.jsx("img",{src:s.featuredImage||((i=s.images)==null?void 0:i[0])||`https://placehold.co/300x200?text=${encodeURIComponent(s.title)}`,alt:s.title}),e.jsx("button",{className:"favorite-btn favorite-btn--active",onClick:()=>de(s.id),"aria-label":a("common.remove"),children:e.jsx(Pe,{size:16})})]}),e.jsxs("div",{className:"favorites__item-content",children:[e.jsx("h3",{className:"favorites__item-title",children:e.jsx(v,{to:`/listing/${s.slug||s.id}`,children:s.title})}),e.jsxs("div",{className:"favorites__item-price",children:[s.price," ",s.currency]}),e.jsx("div",{className:"favorites__item-meta",children:e.jsxs("div",{className:"location",children:[e.jsx(K,{size:12}),e.jsx("span",{children:s.location})]})})]})]},s.id)})}),c.data.totalPages>S.page&&e.jsx("div",{className:"load-more",children:e.jsx("button",{className:"btn-outline",onClick:U,children:a("common.loadMore")})})]}):e.jsxs("div",{className:"favorites__empty",children:[e.jsx("h3",{children:a("profile.noFavorites")}),e.jsx("p",{children:a("profile.noFavoritesDescription")}),e.jsx(v,{to:"/listings",className:"btn-browse",children:a("profile.browseListing")})]})]})]})]})})]})};export{Ee as default};
