import{u as O,a as M,k as I,s as Z,M as z,N as Q,O as W,r as f,c as B,Q as G,S as h,j as e,y as U,f as x,T as H,U as J,V,W as X}from"./index-CEw6XCQe.js";import{u as _}from"./imageServer-F5KcuysI.js";import{a as K}from"./auth-drYXe8pc.js";const ae=()=>{const{t:s}=O(),j=M(),d=I(Z),y=I(z),P=I(Q);W(),f.useEffect(()=>{console.log("Auth token available:",!!y),console.log("User authenticated:",P)},[y,P]);const{data:b,isLoading:R}=B(),[$,{isLoading:w,isError:Y,error:ee}]=G(),[i,E]=f.useState({title:"",description:"",price:0,currency:"AZN",condition:"new",location:"",images:[],categoryId:"",contactPhone:(d==null?void 0:d.phone)||"",contactEmail:(d==null?void 0:d.email)||"",contactWhatsapp:"",contactTelegram:"",tags:""}),[a,F]=f.useState({}),[v,S]=f.useState([]);f.useEffect(()=>{K(d)||(h.error(s("common.loginRequired")),j("/login"))},[d,j,s]);const r=t=>{const{name:n,value:m}=t.target;E(o=>({...o,[n]:m})),a[n]&&F(o=>({...o,[n]:void 0}))},L=t=>{if(t.target.files){const n=Array.from(t.target.files);if(i.images.length+n.length>10){h.warning(s("listings.maxImagesExceeded",{max:10}));return}E(o=>({...o,images:[...o.images,...n]}));const m=n.map(o=>URL.createObjectURL(o));S(o=>[...o,...m])}},q=t=>{const n=[...i.images];n.splice(t,1),E(N=>({...N,images:n}));const m=v[t],o=[...v];o.splice(t,1),S(o),URL.revokeObjectURL(m)},A=()=>{const t={};return i.title.trim()?i.title.length<5&&(t.title=s("listings.titleTooShort")):t.title=s("listings.titleRequired"),i.description.trim()?i.description.length<20&&(t.description=s("listings.descriptionTooShort")):t.description=s("listings.descriptionRequired"),i.price<=0&&(t.price=s("listings.priceRequired")),i.location.trim()||(t.location=s("listings.locationRequired")),i.categoryId||(t.categoryId=s("listings.categoryRequired")),!i.contactPhone&&!i.contactEmail&&(t.contactPhone=s("listings.contactInfoRequired")),F(t),Object.keys(t).length===0},D=async t=>{var m,o,N;if(t.preventDefault(),!A())return;if(!y){h.error(s("auth.sessionExpired"));return}const n=l=>l.toLowerCase().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"");try{const l=await $({title:i.title,description:i.description,price:i.price,currency:i.currency,condition:i.condition,location:i.location,categoryId:i.categoryId,contactPhone:i.contactPhone,contactEmail:i.contactEmail,slug:n(i.title)}).unwrap();if(i.images.length>0&&((m=l.data)!=null&&m.id))try{h.info(s("listings.uploadingImages")),console.log(`Uploading ${i.images.length} images for listing ${l.data.id}`),i.images.forEach((p,T)=>{console.log(`Image ${T+1}: ${p.name}, ${p.type}, ${p.size} bytes`)});const g=new FormData;i.images.forEach(p=>{g.append("images",p)});const c=await _(g);if(!c.success||!c.files)throw new Error(c.message||"Failed to upload images to image server");const k=c.files.map(p=>p.path),C=new FormData;C.append("images",JSON.stringify(k));const u=await X(C,l.data.id);if(u.success&&u.imageUrls)console.log(`Successfully uploaded ${u.imageUrls.length} images:`,u),h.success(s("listings.imageUploadSuccess"));else throw console.log("Image upload response:",u),new Error(u.message||"Failed to update listing with image paths")}catch(g){console.error("Error uploading images:",g),h.error(s("listings.imageUploadError"))}h.success(s("listings.creationSuccess")),(o=l.data)!=null&&o.id?j(`/listings/${l.data.id}`):j("/profile")}catch(l){console.error("Error creating listing:",l);let g=s("listings.creationError");const c=l;(N=c.data)!=null&&N.message?g=c.data.message:c.message&&(g=c.message),h.error(g)}};return R?e.jsx(U,{}):e.jsx("div",{className:"create-listing-page",children:e.jsxs("div",{className:"create-listing-container",children:[e.jsx("h1",{className:"page-title",children:s("listings.createTitle")}),e.jsx("p",{className:"page-subtitle",children:s("listings.createSubtitle")}),e.jsxs("form",{onSubmit:D,className:"listing-form",children:[e.jsxs("div",{className:"form-section",children:[e.jsx("h2",{className:"section-title",children:s("listings.basicInfo")}),e.jsxs("div",{className:`form-group ${a.title?"error":""}`,children:[e.jsxs("label",{htmlFor:"title",children:[s("listings.title")," ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",id:"title",name:"title",value:i.title,onChange:r,placeholder:s("listings.titlePlaceholder"),maxLength:100}),a.title&&e.jsxs("div",{className:"error-message",children:[e.jsx(x,{})," ",a.title]})]}),e.jsxs("div",{className:`form-group ${a.description?"error":""}`,children:[e.jsxs("label",{htmlFor:"description",children:[s("listings.description")," ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("textarea",{id:"description",name:"description",value:i.description,onChange:r,placeholder:s("listings.descriptionPlaceholder"),rows:5}),a.description&&e.jsxs("div",{className:"error-message",children:[e.jsx(x,{})," ",a.description]})]}),e.jsxs("div",{className:`form-group ${a.categoryId?"error":""}`,children:[e.jsxs("label",{htmlFor:"categoryId",children:[s("listings.category")," ",e.jsx("span",{className:"required",children:"*"})]}),e.jsxs("select",{id:"categoryId",name:"categoryId",value:i.categoryId,onChange:r,children:[e.jsx("option",{value:"",children:s("listings.selectCategory")}),b==null?void 0:b.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),a.categoryId&&e.jsxs("div",{className:"error-message",children:[e.jsx(x,{})," ",a.categoryId]})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h2",{className:"section-title",children:s("listings.pricingDetails")}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:`form-group ${a.price?"error":""}`,children:[e.jsxs("label",{htmlFor:"price",children:[s("listings.price")," ",e.jsx("span",{className:"required",children:"*"})]}),e.jsxs("div",{className:"price-input-group",children:[e.jsx("input",{type:"number",id:"price",name:"price",value:i.price||"",onChange:r,min:"0",step:"0.01"}),e.jsxs("select",{name:"currency",value:i.currency,onChange:r,children:[e.jsx("option",{value:"AZN",children:"₼ AZN"}),e.jsx("option",{value:"USD",children:"$ USD"}),e.jsx("option",{value:"EUR",children:"€ EUR"})]})]}),a.price&&e.jsxs("div",{className:"error-message",children:[e.jsx(x,{})," ",a.price]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"condition",children:s("listings.condition")}),e.jsxs("select",{id:"condition",name:"condition",value:i.condition,onChange:r,children:[e.jsx("option",{value:"new",children:s("condition.new")}),e.jsx("option",{value:"like-new",children:s("condition.like-new")}),e.jsx("option",{value:"good",children:s("condition.good")}),e.jsx("option",{value:"fair",children:s("condition.fair")}),e.jsx("option",{value:"poor",children:s("condition.poor")})]})]})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h2",{className:"section-title",children:s("listings.location")}),e.jsxs("div",{className:`form-group ${a.location?"error":""}`,children:[e.jsxs("label",{htmlFor:"location",children:[s("listings.locationLabel")," ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",id:"location",name:"location",value:i.location,onChange:r,placeholder:s("listings.locationPlaceholder")}),a.location&&e.jsxs("div",{className:"error-message",children:[e.jsx(x,{})," ",a.location]})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h2",{className:"section-title",children:s("listings.images")}),e.jsx("p",{className:"section-description",children:s("listings.imagesDescription")}),e.jsxs("div",{className:"image-upload-container",children:[e.jsxs("label",{htmlFor:"images",className:"image-upload-label",children:[e.jsx(H,{className:"upload-icon"}),e.jsx("span",{children:s("listings.uploadImages")}),e.jsxs("span",{className:"image-count",children:[i.images.length,"/10 ",s("listings.imagesUploaded")]})]}),e.jsx("input",{type:"file",id:"images",name:"images",accept:"image/*",multiple:!0,onChange:L,className:"hidden-input"}),v.length>0&&e.jsx("div",{className:"image-previews",children:v.map((t,n)=>e.jsxs("div",{className:"image-preview-item",children:[e.jsx("img",{src:t,alt:`Preview ${n+1}`}),e.jsx("button",{type:"button",className:"remove-image-btn",onClick:()=>q(n),children:e.jsx(J,{})})]},n))})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h2",{className:"section-title",children:s("listings.contactInfo")}),e.jsxs("div",{className:`form-group ${a.contactPhone?"error":""}`,children:[e.jsx("label",{htmlFor:"contactPhone",children:s("listings.contactPhone")}),e.jsx("input",{type:"tel",id:"contactPhone",name:"contactPhone",value:i.contactPhone,onChange:r,placeholder:s("listings.contactPhonePlaceholder")}),a.contactPhone&&e.jsxs("div",{className:"error-message",children:[e.jsx(x,{})," ",a.contactPhone]}),e.jsx("p",{className:"help-text",children:s("listings.contactInfoHelp")})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"contactEmail",children:s("listings.contactEmail")}),e.jsx("input",{type:"email",id:"contactEmail",name:"contactEmail",value:i.contactEmail,onChange:r,placeholder:s("listings.contactEmailPlaceholder")})]})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:()=>j(-1),disabled:w,children:s("common.cancel")}),e.jsx("button",{type:"submit",className:"btn-primary",disabled:w,children:w?e.jsxs(e.Fragment,{children:[e.jsx(U,{size:"small"}),s("common.submitting")]}):e.jsxs(e.Fragment,{children:[e.jsx(V,{}),s("listings.createButton")]})})]})]})]})})};export{ae as default};
