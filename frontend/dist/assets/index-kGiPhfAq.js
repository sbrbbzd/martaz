import{u as O,a as Y,i as $,k as S,s as Q,M as X,N as J,q as K,c as W,X as ee,r as h,S as p,Y as ie,j as e,y as D,E as se,H as te,U as ae,T as ne,f as le,Z as oe}from"./index-CEw6XCQe.js";import{i as T}from"./auth-drYXe8pc.js";import{u as re}from"./imageServer-F5KcuysI.js";const pe=()=>{const{t:i}=O(),x=Y(),{id:f}=$(),r=S(Q),k=S(X),b=S(J),{data:g,isLoading:z,error:R}=K(f||""),{data:C,isLoading:M}=W(),[L,{isLoading:ce}]=ee(),[a,E]=h.useState({title:"",description:"",price:0,currency:"AZN",condition:"good",location:"",images:[],categoryId:"",contactPhone:"",contactEmail:"",status:"active"}),[v,A]=h.useState([]),[y,w]=h.useState([]),[G,_]=h.useState([]),[F,U]=h.useState(!1),[o,q]=h.useState({});h.useEffect(()=>{var n,t;if(console.log("==== EDIT LISTING PAGE DEBUG ===="),console.log("Auth state - isAuthenticated:",b),console.log("Current user:",r),console.log("Auth token:",k),g!=null&&g.data){const s=g.data;if(console.log("Listing data:",JSON.stringify(g.data)),!s){console.error("Listing data is missing or malformed"),p.error(i("listings.notFound","Listing not found")),x("/");return}const l=(n=r==null?void 0:r.id)==null?void 0:n.toString(),c=(t=s.userId)==null?void 0:t.toString(),d=l===c,u=r&&T(r);if(console.log("Authorization check:"),console.log("currentUserId:",l,"type:",typeof l),console.log("listingUserId:",c,"type:",typeof c),console.log("Direct comparison:",(r==null?void 0:r.id)===s.userId),console.log("String comparison:",l===c),console.log("isOwner:",d,"isAdmin:",u),!d&&!u){console.error("Authorization failed - redirecting to home"),p.error(i("listings.notAuthorized","You are not authorized to edit this listing")),x("/");return}console.log("Authorization passed - continuing with edit form");const j=typeof s.price=="string"?parseFloat(s.price):s.price;E({title:s.title||"",description:s.description||"",price:isNaN(j)?0:j,currency:s.currency||"AZN",condition:s.condition||"good",location:s.location||"",images:[],categoryId:s.categoryId||"",contactPhone:s.contactPhone||"",contactEmail:s.contactEmail||"",status:s.status||"active"});const N=s.images||[];console.log("Setting existing images:",N.length),A(N),_(N),w([])}},[g,r,x,i]),h.useEffect(()=>{const n=ie();console.log("Auth debug result:",n),b||(p.error(i("auth.notAuthenticated","You must be logged in to edit a listing")),x("/login",{state:{from:`/listings/${f}/edit`}}))},[b,x,i,f]);const m=n=>{const{name:t,value:s}=n.target;if(q(l=>({...l,[t]:""})),t==="price"){const l=parseFloat(s);E(c=>({...c,[t]:s===""||isNaN(l)?0:l}))}else E(l=>({...l,[t]:s}))},V=n=>{const t=n.target.files;if(!t)return;const s=Array.from(t);if(s.filter(d=>{const u=d.size<=5242880,j=["image/jpeg","image/png","image/webp"].includes(d.type);return!u||!j}).length>0){p.error(i("listings.invalidImageFiles","Some files were rejected (max 5MB, jpg/png/webp only)"));return}w(d=>[...d,...s]);const c=s.map(d=>URL.createObjectURL(d));_(d=>[...d,...c])},B=n=>{if(n<v.length)A(t=>t.filter((s,l)=>l!==n)),_(t=>{const s=[...t];return s.splice(n,1),s});else{const t=n-v.length;w(s=>s.filter((l,c)=>c!==t)),_(s=>{const l=[...s];return l.splice(n,1),l})}},Z=()=>{const n={};let t=!0;return console.log("Validating form with data:",a),console.log("Existing images:",v.length,"New images:",y.length),(!a.title||a.title.length<3)&&(n.title=i("listings.titleRequired","Title must be at least 3 characters"),t=!1,console.log("Title validation failed:",a.title)),(!a.description||a.description.length<10)&&(n.description=i("listings.descriptionRequired","Description must be at least 10 characters"),t=!1,console.log("Description validation failed:",a.description)),a.price<=0&&(console.log("Price validation failed:",a.price),n.price=i("listings.priceRequired","Price must be greater than 0"),t=!1),a.location||(console.log("Location validation failed"),n.location=i("listings.locationRequired","Location is required"),t=!1),a.categoryId||(console.log("Category validation failed"),n.categoryId=i("listings.categoryRequired","Category is required"),t=!1),v.length===0&&y.length===0&&(console.log("Images validation failed - no images found"),n.images=i("listings.imagesRequired","At least one image is required"),t=!1),q(n),t?console.log("Form validation passed"):console.log("Form validation failed with errors:",n),t},H=async n=>{var t,s;if(n.preventDefault(),console.log("Starting form submission"),!Z()){console.error("Form validation failed"),p.error(i("listings.formHasErrors","Please correct the errors in the form"));return}U(!0);try{console.log("Updating listing details...");const l={title:a.title,description:a.description,price:a.price,currency:a.currency,condition:a.condition,location:a.location,categoryId:a.categoryId,contactPhone:a.contactPhone,contactEmail:a.contactEmail,status:a.status},c=await L({id:f||"",listing:l}).unwrap();if(console.log("Update listing response:",c),y.length>0||((s=(t=g==null?void 0:g.data)==null?void 0:t.images)==null?void 0:s.length)!==v.length)try{let u=[];if(y.length>0){p.info(i("listings.uploadingImages"));const N=new FormData;y.forEach(P=>{N.append("images",P)});const I=await re(N);if(console.log("Image upload response:",I),!I.success||!I.files)throw new Error("Failed to upload new images");u=I.files.map(P=>P.path)}const j=[...v,...u];console.log("Final images list:",j),await L({id:f||"",listing:{...l,images:j}}).unwrap(),p.success(i("listings.updateSuccess"))}catch(u){console.error("Error updating images:",u),p.error(i("listings.imageUploadError"))}else p.success(i("listings.updateSuccess"));x(`/listings/${f}`)}catch(l){console.error("Error updating listing:",l),p.error(i("listings.updateError"))}finally{U(!1)}};return z||M?e.jsx(D,{size:"large",text:i("listings.loading","Loading...")}):R||!g?e.jsx(se,{message:i("listings.notFound","Listing not found")}):e.jsxs("div",{className:"create-listing-page",children:[e.jsx(te,{children:e.jsxs("title",{children:[i("listings.editTitle","Edit Listing")," | ",i("app.name","Mart.az")]})}),e.jsxs("div",{className:"container",children:[e.jsx("div",{className:"create-listing-page__header",children:e.jsx("h1",{children:i("listings.editTitle","Edit Listing")})}),e.jsxs("form",{className:"create-listing-page__form",onSubmit:H,children:[e.jsxs("div",{className:"create-listing-page__section",children:[e.jsx("h2",{children:i("listings.basicDetails","Basic Details")}),e.jsxs("div",{className:"create-listing-page__field",children:[e.jsxs("label",{htmlFor:"title",children:[i("listings.title","Title")," ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",id:"title",name:"title",value:a.title,onChange:m,placeholder:i("listings.titlePlaceholder","Enter a descriptive title"),required:!0,className:o.title?"error":""}),o.title&&e.jsx("span",{className:"error-message",children:o.title})]}),e.jsxs("div",{className:"create-listing-page__field",children:[e.jsxs("label",{htmlFor:"description",children:[i("listings.description","Description")," ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("textarea",{id:"description",name:"description",value:a.description,onChange:m,placeholder:i("listings.descriptionPlaceholder","Describe your item in detail"),rows:5,required:!0,className:o.description?"error":""}),o.description&&e.jsx("span",{className:"error-message",children:o.description})]}),e.jsxs("div",{className:"create-listing-page__field-group",children:[e.jsxs("div",{className:"create-listing-page__field",children:[e.jsxs("label",{htmlFor:"price",children:[i("listings.price","Price")," ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"number",id:"price",name:"price",value:a.price,onChange:m,placeholder:"0.00",min:"0",step:"0.01",required:!0,className:o.price?"error":""}),o.price&&e.jsx("span",{className:"error-message",children:o.price})]}),e.jsxs("div",{className:"create-listing-page__field",children:[e.jsx("label",{htmlFor:"currency",children:i("listings.currency","Currency")}),e.jsxs("select",{id:"currency",name:"currency",value:a.currency,onChange:m,children:[e.jsx("option",{value:"AZN",children:"AZN"}),e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"EUR",children:"EUR"})]})]})]}),e.jsxs("div",{className:"create-listing-page__field-group",children:[e.jsxs("div",{className:"create-listing-page__field",children:[e.jsx("label",{htmlFor:"condition",children:i("listings.condition","Condition")}),e.jsxs("select",{id:"condition",name:"condition",value:a.condition,onChange:m,children:[e.jsx("option",{value:"new",children:i("condition.new","New")}),e.jsx("option",{value:"like-new",children:i("condition.like-new","Like New")}),e.jsx("option",{value:"good",children:i("condition.good","Good")}),e.jsx("option",{value:"fair",children:i("condition.fair","Fair")}),e.jsx("option",{value:"poor",children:i("condition.poor","Poor")})]})]}),e.jsxs("div",{className:"create-listing-page__field",children:[e.jsxs("label",{htmlFor:"location",children:[i("listings.location","Location")," ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",id:"location",name:"location",value:a.location,onChange:m,placeholder:i("listings.locationPlaceholder","e.g., Baku, Azerbaijan"),required:!0,className:o.location?"error":""}),o.location&&e.jsx("span",{className:"error-message",children:o.location})]})]}),e.jsxs("div",{className:"create-listing-page__field",children:[e.jsxs("label",{htmlFor:"categoryId",children:[i("listings.category","Category")," ",e.jsx("span",{className:"required",children:"*"})]}),e.jsxs("select",{id:"categoryId",name:"categoryId",value:a.categoryId,onChange:m,required:!0,className:o.categoryId?"error":"",children:[e.jsx("option",{value:"",children:i("listings.selectCategory","Select a category")}),C&&C.map(n=>e.jsx("option",{value:n.id,children:n.name},n.id))]}),o.categoryId&&e.jsx("span",{className:"error-message",children:o.categoryId})]})]}),e.jsxs("div",{className:"create-listing-page__section",children:[e.jsx("h2",{children:i("listings.images","Images")}),e.jsxs("div",{className:"create-listing-page__images",children:[G.map((n,t)=>e.jsxs("div",{className:"create-listing-page__image-preview",children:[e.jsx("img",{src:n,alt:`Preview ${t+1}`}),e.jsx("button",{type:"button",className:"create-listing-page__image-remove",onClick:()=>B(t),children:e.jsx(ae,{})})]},t)),e.jsxs("label",{className:"create-listing-page__image-upload",children:[e.jsx("input",{type:"file",accept:"image/jpeg,image/png,image/webp",multiple:!0,onChange:V}),e.jsxs("div",{className:"create-listing-page__upload-content",children:[e.jsx(ne,{size:24}),e.jsx("span",{children:i("listings.uploadImages","Upload Images")})]})]})]}),o.images&&e.jsx("span",{className:"error-message",children:o.images}),e.jsxs("p",{className:"create-listing-page__image-tip",children:[e.jsx(le,{}),i("listings.imageHelp","Add clear photos to get more interest. Maximum 5MB per image, jpg/png formats.")]})]}),e.jsxs("div",{className:"create-listing-page__section",children:[e.jsx("h2",{children:i("listings.contactInfo","Contact Information")}),e.jsxs("div",{className:"create-listing-page__field",children:[e.jsx("label",{htmlFor:"contactPhone",children:i("listings.contactPhone","Phone Number")}),e.jsx("input",{type:"tel",id:"contactPhone",name:"contactPhone",value:a.contactPhone,onChange:m,placeholder:i("listings.contactPhonePlaceholder","e.g., +994 50 123 4567")})]}),e.jsxs("div",{className:"create-listing-page__field",children:[e.jsx("label",{htmlFor:"contactEmail",children:i("listings.contactEmail","Email")}),e.jsx("input",{type:"email",id:"contactEmail",name:"contactEmail",value:a.contactEmail,onChange:m,placeholder:i("listings.contactEmailPlaceholder","e.g., name@example.com")})]})]}),r&&T(r)&&e.jsxs("div",{className:"create-listing-page__section",children:[e.jsx("h2",{children:i("listings.status","Listing Status")}),e.jsxs("div",{className:"create-listing-page__field",children:[e.jsx("label",{htmlFor:"status",children:i("listings.status","Status")}),e.jsxs("select",{id:"status",name:"status",value:a.status,onChange:m,children:[e.jsx("option",{value:"active",children:i("status.active","Active")}),e.jsx("option",{value:"pending",children:i("status.pending","Pending")}),e.jsx("option",{value:"sold",children:i("status.sold","Sold")}),e.jsx("option",{value:"expired",children:i("status.expired","Expired")})]})]})]}),e.jsxs("div",{className:"create-listing-page__actions",children:[e.jsx("button",{type:"button",className:"create-listing-page__cancel",onClick:()=>x(-1),disabled:F,children:i("common.cancel","Cancel")}),e.jsx("button",{type:"submit",className:"create-listing-page__submit",disabled:F,children:F?e.jsxs(e.Fragment,{children:[e.jsx(D,{size:"small"}),i("listings.updating","Updating...")]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{}),i("listings.updateListing","Update Listing")]})})]})]})]})]})};export{pe as default};
